@model ShopBanHang.Areas.Admin.Models.ProductCreateViewModel
@{
    ViewData["Title"] = "Thêm sản phẩm mới";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<h2>@ViewData["Title"]</h2>
<hr />
<div class="row">
    <div class="col-md-8">
        <form asp-action="Create" method="post" enctype="multipart/form-data">
            <div asp-validation-summary="All" class="text-danger"></div>

            <div class="form-group">
                <label asp-for="TenSP" class="control-label"></label>
                <input asp-for="TenSP" class="form-control" />
                <span asp-validation-for="TenSP" class="text-danger"></span>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="DonGia" class="control-label"></label>
                        <input asp-for="DonGia" class="form-control" />
                        <span asp-validation-for="DonGia" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="DonGiaKhuyenMai" class="control-label"></label>
                        <input asp-for="DonGiaKhuyenMai" class="form-control" />
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label asp-for="MoTa" class="control-label"></label>
                <textarea asp-for="MoTa" class="form-control" rows="3"></textarea>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="maLoaiDen"></label>
                        <div class="input-group">
                            <select asp-for="maLoaiDen" class="form-control" asp-items="ViewBag.Categories">
                                <option value="">-- Chọn loại sản phẩm --</option>
                            </select>
                            <button type="button" class="btn btn-outline-primary" data-toggle="modal" data-target="#addCategoryModal" title="Thêm danh mục mới">
                                <i class="fa fa-plus"></i>
                            </button>
                        </div>
                        <span asp-validation-for="maLoaiDen" class="text-danger"></span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label asp-for="so_Luong_Ton" class="control-label"></label>
                        <input asp-for="so_Luong_Ton" type="number" class="form-control" />
                        <span asp-validation-for="so_Luong_Ton" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label asp-for="mauSac" class="control-label"></label>
                        <input asp-for="mauSac" class="form-control" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label asp-for="kichThuoc" class="control-label"></label>
                        <input asp-for="kichThuoc" class="form-control" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label asp-for="thuongHieu" class="control-label"></label>
                        <input asp-for="thuongHieu" class="form-control" />
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label asp-for="Images" class="control-label"></label>
                <div id="image-upload-container">
                    <div class="input-group mb-2">
                        <input type="file" name="Images" class="form-control" />
                        <button type="button" id="add-more-image" class="btn btn-secondary btn-sm mt-2">+</button>
                        <span asp-validation-for="Images" class="text-danger"></span>
                    </div>
                    
                </div>
                
            </div>

            <div class="form-group form-check">
                <label class="form-check-label">
                    <input class="form-check-input" asp-for="trangThai" /> @Html.DisplayNameFor(model => model.trangThai)
                </label>
            </div>

            <div class="form-group">
                <input type="submit" value="Tạo mới" class="btn btn-primary" />
                <a asp-action="Index" class="btn btn-outline-secondary">Quay lại danh sách</a>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="addCategoryModal" tabindex="-1" role="dialog" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCategoryModalLabel">Thêm danh mục mới</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newCategoryName">Tên danh mục</label>
                    <input type="text" id="newCategoryName" class="form-control" placeholder="Ví dụ: Đèn LED âm trần">
                    <small id="category-error" class="text-danger"></small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" id="btn-save-category" class="btn btn-primary">Lưu</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // --- PHẦN 1: LOGIC THÊM ẢNH ĐỘNG (GIỮ NGUYÊN) ---
            document.getElementById('add-more-image').addEventListener('click', function () {
                const container = document.getElementById('image-upload-container');
                const newDiv = document.createElement('div');
                newDiv.classList.add('input-group', 'mb-2');
                newDiv.innerHTML = `
                    <input type="file" name="Images" class="form-control" required />
                    <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">Xóa</button>
                `;
                container.appendChild(newDiv);
            });

            // --- PHẦN 2: LOGIC MỚI CHO VIỆC THÊM DANH MỤC BẰNG AJAX ---
            const saveCategoryBtn = document.getElementById('btn-save-category');
            const newCategoryNameInput = document.getElementById('newCategoryName');
            const categoryDropdown = document.querySelector('select[name="maLoaiDen"]');
            const errorLabel = document.getElementById('category-error');

            saveCategoryBtn.addEventListener('click', async function() {
                const categoryName = newCategoryNameInput.value.trim();
                errorLabel.textContent = '';

                if (!categoryName) {
                    errorLabel.textContent = 'Tên danh mục không được để trống.';
                    return;
                }

                saveCategoryBtn.disabled = true;
                saveCategoryBtn.textContent = 'Đang lưu...';

                try {
                    // Gọi API bằng AJAX (fetch)
                    const response = await fetch('/api/admin/category/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // Chú ý: Cần thêm token chống giả mạo (anti-forgery token) nếu API của bạn yêu cầu
                        },
                        body: JSON.stringify({ tenLoaiSP: categoryName })
                    });

                    if (!response.ok) {
                        const errorData = await response.text();
                        throw new Error(errorData || 'Không thể tạo danh mục.');
                    }

                    const newCategory = await response.json();

                    // Tạo một <option> mới từ dữ liệu API trả về
                    const newOption = new Option(newCategory.tenLoaiSp, newCategory.maLoaiSp, true, true);

                    // Thêm option mới vào dropdown và tự động chọn nó
                    categoryDropdown.add(newOption);

                    // Đóng modal (cần jQuery vì template của bạn dùng nó)
                    $('#addCategoryModal').modal('hide');
                    newCategoryNameInput.value = ''; // Xóa trắng ô input

                } catch (error) {
                    errorLabel.textContent = 'Lỗi: ' + error.message;
                } finally {
                    // Kích hoạt lại nút Lưu dù thành công hay thất bại
                    saveCategoryBtn.disabled = false;
                    saveCategoryBtn.textContent = 'Lưu';
                }
            });
        });
    </script>
}